#
# Copyright (C) 2015 Eaton
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#

#! \file   sysinfo-version.sh.manualtest
#  \author Jim Klimov <EvgenyKlimov@Eaton.com>
#  \brief  Request server version (for quick manual inspection)

echo
echo "###################################################################################################"
echo "********* sysinfo-version.sh.manualtest ********************************* START *******************"
echo "###################################################################################################"
echo

echo "***************************************************************************************************"
echo "********* Prerequisites ***************************************************************************"
echo "***************************************************************************************************"
init_script
[ x"${JSONSH_CLI_DEFINED-}" = xyes ] || CODE=127 die "jsonsh_cli() not defined"

######################################################################
# Short test to just get the authorized version / process status info
# Check getting server system info (authorized only?)
###############################################################
test_it "sysinfo_get_auth=2_raw__version_procstatus"
curlfail_push "warn" ""
SYSINFOARAW="`api_auth_get '/admin/sysinfo'`"
RES=$?
curlfail_pop
echo "=== SYSINFOARAW ($RES):" >&2
echo "$SYSINFOARAW" >&2
if [ $RES = 0 ]; then
    echo "$SYSINFOARAW" | egrep 'HTTP/1\.. 401' && \
    echo "Got HTTP-401 Unauthorized, this is no longer expected" && RES=124
fi >&2
if [ $RES = 0 ]; then
    echo "$SYSINFOARAW" | egrep 'HTTP/1\.. 4' && \
    echo "Got HTTP-4xx error" && RES=123
fi >&2
print_result $RES

echo
echo "###################################################################################################"
echo "********* sysinfo-version.sh.manualtest ********************************** END ********************"
echo "###################################################################################################"
echo
