#!/bin/sh

# Copyright (C) 2014 Eaton
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
#! \file   db-init(.in)
#  \brief  Inits the BIOS database schema on factory-default installations
#  \author Karol Hrdina <KarolHrdina@Eaton.com>
#  \author Alena Chernikava <AlenaChernikava@Eaton.com>
#

prefix="@prefix@"

INITSQL="@datarootdir@/@PACKAGE@/sql/mysql/initdb.sql"

[ \! -r /etc/default/mysql-root-passwd ] || . /etc/default/mysql-root-passwd

do_mysql() {
	if [ -z "$MYSQL_ROOT_PASSWD" ]; then
		mysql -u root
	else
		mysql -u root -p"$MYSQL_ROOT_PASSWD"
	fi
}

if [ -z "`echo "select 'working';" | do_mysql | grep working`" ]; then
	if [ -z "`echo "select 'working';" | MYSQL_ROOT_PASSWD='' do_mysql | grep working`" ]; then
		echo "Can't connect to database"
		exit 1
	else
		echo "Configuration files inconsistent: really MYSQL_ROOT_PASSWD is empty"
		MYSQL_ROOT_PASSWD=''
	fi
fi

if [ -z "`echo 'show databases;' | do_mysql | egrep '^box_utf8$'`" ]; then
	if [ -r "$INITSQL" ] && \
	   [ -s "$INITSQL" ]; then
		echo "Database for BIOS not found - importing schema..."
		cat "$INITSQL" | do_mysql || exit 1

		echo "Database for BIOS - generating passwords..."

		BIOS_RW="`head -c 12 /dev/urandom | base64`"
		BIOS_RO="`head -c 12 /dev/urandom | base64`"
		[ -n "$MYSQL_ROOT_PASSWD" ] && \
			ROOT_PW="$MYSQL_ROOT_PASSWD=" || \
			ROOT_PW="`head -c 12 /dev/urandom | base64`"

		cat << EOF | do_mysql
GRANT DELETE,INSERT,SELECT,UPDATE ON box_utf8.* TO 'bios-rw'@'localhost' IDENTIFIED BY '$BIOS_RW';
GRANT SELECT                      ON box_utf8.* TO 'bios-ro'@'localhost' IDENTIFIED BY '$BIOS_RO';
SET PASSWORD = PASSWORD('$ROOT_PW');
FLUSH PRIVILEGES;
EOF
		echo "MYSQL_ROOT_PASSWD=\"$ROOT_PW\"" > /etc/default/mysql-root-passwd
		chmod 600 /etc/default/mysql-root-passwd
		echo "DB_USER=bios-rw" > /etc/default/bios-db-rw
		echo "DB_PASSWD=$BIOS_RW" >> /etc/default/bios-db-rw
		echo "DB_USER=bios-ro" > /etc/default/bios-db-ro
		echo "DB_PASSWD=$BIOS_RO" >> /etc/default/bios-db-ro
		chown bios /etc/default/bios-db*
		chmod 600 /etc/default/bios-db*
	else
		echo "Can't read '$INITSQL' !!!"
		exit 1
	fi
fi
