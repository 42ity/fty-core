#!/bin/bash

#
# Copyright (C) 2015 Eaton
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#

#! \file verify-fs.sh
#  \author Michal Vyskocil <MichalVyskocil@Eaton.com>
#  \brief Verify the filesystem and report suspicious things
#

DEFAULT=/etc/default/verify-fs
case "$(uname -m)" in
x86_64 | i?86)
    OVERLAY=/run/initramfs/mnt/root-rw/overlay
    IMAGES=/run/initramfs/mnt/disk/rootfs
    ;;
*)
    OVERLAY=/mnt/nand/overlay
    IMAGES=/mnt/nand/rootfs
esac

die () {
    echo "${@}" >&2
    exit 1
}

is_tree_empty () {
    local dir excludes
    dir=${1}

    # build chain of -not -path foo -or -not -path bar from args
    shift 1
    [[ -n ${1} ]] && excludes="-not -path '${1}'"
    shift 1
    while [[ -n ${1} ]]; do
        excludes="${excludes} -or -not -path '${1}'"
        shift 1
    done

    [[ $(find "${dir}" -xdev -type f ${excludes} | wc -l) == 0 ]]

}

log () {
    /usr/bin/logger -i -p security.err -t "verify-fs" "${@}"
}

cat_default () {
    if [[ ! -f "${DEFAULT}" ]]; then
        cat <<EOF
bin:
sbin:
lib:
lib64:
usr:local
EOF
        return
    fi
    /bin/grep -v '^#' "${DEFAULT}"
}

##### MAIN #####

## 0.) Check the paths

[[ $(< /proc/mounts) =~ upperdir=${OVERLAY} ]] || \
    die "Can't find overlay ${OVERLAY}"

[[ -d ${IMAGES} ]] || \
    die "Can't find images ${IMAGES}"

## 1.) Verify the images
pushd "${IMAGES}"
for ROOTFS in *.squashfs; do

    /usr/bin/md5sum -c "${ROOTFS}.md5" 2>/dev/null || \
        log "Bad integrity of ${ROOTFS}, checksum is not valid"

done
popd

## 2.) Verify the overlayfs
cat_default | while read LINE; do
    TREE=${LINE%%:*}
    EXCLUDES=${LINE#*:}

    [[ -d "${OVERLAY}/${TREE}" ]] || continue

    is_tree_empty "${OVERLAY}/${TREE}" ${EXCLUDES//:/ } || \
        log "${OVERLAY}/${TREE} contains suspicious files."
done
