#!/bin/bash

#
# Copyright (C) 2015 - 2020 Eaton
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#

#! \file verify-fs.sh
#  \author Michal Vyskocil <MichalVyskocil@Eaton.com>
#  \author Jim Klimov <EvgenyKlimov@Eaton.com>
#  \author Clement Perrette <ClementPerrette@Eaton.com>
#  \brief Verify the filesystem and report suspicious things
#

OVERLAY=@OVERLAY_PATH@
DEFAULT=/etc/default/verify-fs
IMAGES=@IMAGES_PATH@

JSONSH="@datadir@/@PACKAGE@/scripts/JSON.sh"
get_a_string_arg() { "$JSONSH" --get-string "$1" ; }

die () {
    echo "${@}" >&2
    exit 1
}

is_tree_empty () {
    local dir excludes
    dir=${1}
    shift 1

    # build chain of -not -path foo -or -not -path bar from args
    while [[ -n ${1} ]]; do
        excludes=("${excludes[@]}" -path "$dir/$1" -prune -or)
        shift 1
    done

    [[ $(find "${dir}" -xdev "${excludes[@]}" -type f -print | wc -l) == 0 ]]
}

log () {
    if $interactive; then
        echo "$@" >&2
    else
        /usr/bin/logger -i -p security.err -t "verify-fs" "${@}"
    fi
}

cat_default () {
    if [[ ! -f "${DEFAULT}" ]]; then
        cat <<EOF
bin:
sbin:
lib:modules
lib64:
usr:local
EOF
        return
    fi
    /bin/grep -v '^#' "${DEFAULT}"
}

##### MAIN #####

## 0.) Check the paths

[[ $(< /proc/mounts) =~ upperdir=${OVERLAY} ]] || \
    die "Can't find overlay ${OVERLAY}"

[[ -d ${IMAGES} ]] || \
    die "Can't find images ${IMAGES}"

## 1.) Verify the images
pushd "${IMAGES}" >/dev/null
for ROOTFS in *.squashfs; do

    if [ -s "${ROOTFS}.md5" ] ; then
        if /usr/bin/md5sum -c "${ROOTFS}.md5" 2>/dev/null; then
            log "Good integrity of ${ROOTFS}, MD5 checksum is valid"
        else
            log "Bad integrity of ${ROOTFS}, MD5 checksum is not valid"
        fi
    else
        log "Missing MD5 checksum file: '${ROOTFS}.md5'"
    fi

    if [ -s "${ROOTFS}.sha256" ] ; then
        if /usr/bin/sha256sum -c "${ROOTFS}.sha256" 2>/dev/null; then
            if [ -s "${ROOTFS}-manifest.json" ] ; then
                    SHA256_COMPUTED=$(cut -d ' ' -f1 < "${ROOTFS}.sha256")
                    SHA256_MANIFEST=$(get_a_string_arg '^"application","ShaChecksum"$' < "${ROOTFS}-manifest.json")

                if [ "${SHA256_COMPUTED}" = "${SHA256_MANIFEST}" ]; then
                    if [ -s "${ROOTFS}-manifest.json.p7s" ] ; then
                        SIGNED_BY=$(get_a_string_arg '^"application","SignedBy"$' < "${ROOTFS}-manifest.json")

                        if openssl cms -verify -binary -inform der -CAfile "/usr/share/authorities/${SIGNED_BY}/rootCa1.pem" -purpose any -out /dev/null -content "${ROOTFS}-manifest.json" -in "${ROOTFS}-manifest.json.p7s"; then
                            log "Image signature is valid for ${ROOTFS}"
                        else
                            log "Image signature is invalid for ${ROOTFS}"
                        fi
                    else
                        log "Manifest signature not found for ${ROOTFS}"
                    fi
                else
                    log "Manifest sha256 hash does not match with the sha256 hash for ${ROOTFS}"
                fi
            else
                log "Manifest not found for ${ROOTFS}"
            fi
        else
            log "Bad integrity of ${ROOTFS}, SHA256 checksum is not valid"
        fi
    else
        log "Missing SHA256 checksum file: '${ROOTFS}.sha256'"
    fi

done
popd >/dev/null

if tty -s; then
    interactive=true
else
    interactive=false
fi

## 2.) Verify the overlayfs
cat_default | while read LINE; do
    TREE=${LINE%%:*}
    EXCLUDES=${LINE#*:}

    [[ -d "${OVERLAY}/${TREE}" ]] || continue

    is_tree_empty "${OVERLAY}/${TREE}" ${EXCLUDES//:/ } || \
        log "${OVERLAY}/${TREE} contains suspicious files."
done
